# 🏗️ Архитектура Native Module - Визуальная схема

## 📊 Полная архитектура Turbo Module + Codegen

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          РАЗРАБОТКА (Development Time)                       │
└─────────────────────────────────────────────────────────────────────────────┘

    1. Вы пишете TypeScript спецификацию
    ┌──────────────────────────────────────┐
    │  specs/NativeCalculator.ts           │
    │                                      │
    │  export interface Spec {             │
    │    add(a: number, b: number): number;│
    │    factorial(n: number): Promise<T>; │
    │    squareRoot(..., callback): void;  │
    │  }                                   │
    └──────────────┬───────────────────────┘
                   │
                   │  2. Настраиваете package.json
                   ↓
    ┌──────────────────────────────────────┐
    │  package.json                        │
    │                                      │
    │  "codegenConfig": {                  │
    │    "name": "NativeCalculatorSpec",   │
    │    "jsSrcsDir": "specs",            │
    │    "ios": {                          │
    │      "modulesProvider": {            │
    │        "NativeCalculator":           │
    │          "RCTNativeCalculator"       │
    │      }                                │
    │    }                                 │
    │  }                                   │
    └──────────────┬───────────────────────┘
                   │
                   │  3. Запускаете pod install
                   ↓
    ┌──────────────────────────────────────┐
    │      REACT NATIVE CODEGEN            │
    │         (автоматический)             │
    │                                      │
    │  • Читает TypeScript спецификацию    │
    │  • Анализирует типы и методы         │
    │  • Генерирует нативный код           │
    └──────────────┬───────────────────────┘
                   │
                   │  4. Генерируются файлы
                   ↓
    ┌──────────────────────────────────────────────────────┐
    │  ios/build/generated/ios/                            │
    │                                                      │
    │  ┌─────────────────────────────────────┐            │
    │  │ NativeCalculatorSpec.h              │  ← Протокол│
    │  │                                     │            │
    │  │ @protocol NativeCalculatorSpec      │            │
    │  │   - (NSNumber *)add:(double)a       │            │
    │  │                   b:(double)b;      │            │
    │  │   - (void)factorial:(double)n       │            │
    │  │           resolve:(...)             │            │
    │  │           reject:(...);              │            │
    │  │ @end                                │            │
    │  └─────────────────────────────────────┘            │
    │                                                      │
    │  ┌─────────────────────────────────────┐            │
    │  │ NativeCalculatorSpecJSI.h           │  ← JSI     │
    │  │                                     │            │
    │  │ class NativeCalculatorSpecJSI {     │            │
    │  │   double add(jsi::Runtime&,         │            │
    │  │              double a, double b);   │            │
    │  │   jsi::Value factorial(...);        │            │
    │  │ }                                   │            │
    │  └─────────────────────────────────────┘            │
    └──────────────────────────────────────────────────────┘
                   │
                   │  5. Вы реализуете протокол
                   ↓
    ┌──────────────────────────────────────┐
    │  ios/NativeCalculator/               │
    │  RCTNativeCalculator.mm              │
    │                                      │
    │  @interface RCTNativeCalculator :    │
    │    NSObject <NativeCalculatorSpec>   │
    │  @end                                │
    │                                      │
    │  @implementation RCTNativeCalculator │
    │    - (double)add:(double)a           │
    │                b:(double)b {         │
    │      return a + b;                   │
    │    }                                 │
    │  @end                                │
    └──────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                        ВЫПОЛНЕНИЕ (Runtime Execution)                        │
└─────────────────────────────────────────────────────────────────────────────┘

    ЗАПУСК ПРИЛОЖЕНИЯ:

    ┌──────────────────────────────────────┐
    │  React Native инициализируется       │
    └──────────────┬───────────────────────┘
                   │
                   ↓
    ┌──────────────────────────────────────┐
    │  Сканирование модулей:               │
    │                                      │
    │  1. Читает RCTModuleProviders.mm     │
    │  2. Находит RCTNativeCalculator      │
    │  3. Вызывает [... moduleName]        │
    │     → "NativeCalculator"             │
    │  4. Регистрирует в реестре           │
    └──────────────┬───────────────────────┘
                   │
                   ↓
    ┌──────────────────────────────────────┐
    │  TurboModuleRegistry готов           │
    │  Модуль зарегистрирован, но          │
    │  НЕ СОЗДАН (lazy loading)            │
    └──────────────────────────────────────┘


    ПЕРВЫЙ ВЫЗОВ ИЗ JAVASCRIPT:

    ┌────────────────────────────────────────────────────────────────┐
    │  JavaScript (App.tsx)                                          │
    │                                                                │
    │  import NativeCalculator from './specs/NativeCalculator';      │
    │  const sum = NativeCalculator.add(5, 3);                      │
    └──────────────┬─────────────────────────────────────────────────┘
                   │
                   ↓
    ┌──────────────────────────────────────┐
    │  TurboModuleRegistry                 │
    │                                      │
    │  getEnforcing('NativeCalculator')    │
    │                                      │
    │  1. Проверяет кэш - модуля нет       │
    │  2. Создает RCTNativeCalculator      │
    │  3. Вызывает getTurboModule:         │
    └──────────────┬───────────────────────┘
                   │
                   ↓
    ┌──────────────────────────────────────┐
    │  RCTNativeCalculator.mm              │
    │                                      │
    │  - (shared_ptr<TurboModule>)         │
    │      getTurboModule:(InitParams&) {  │
    │    return make_shared<               │
    │      NativeCalculatorSpecJSI>        │
    │        (params);                     │
    │  }                                   │
    │                                      │
    │  ← Возвращает JSI объект             │
    └──────────────┬───────────────────────┘
                   │
                   ↓
    ┌──────────────────────────────────────┐
    │  TurboModuleRegistry                 │
    │                                      │
    │  • Кэширует модуль (singleton)       │
    │  • Связывает с JSI                   │
    │  • Готов к вызовам                   │
    └──────────────┬───────────────────────┘
                   │
                   ↓
    ┌──────────────────────────────────────┐
    │  JavaScript Runtime                  │
    │                                      │
    │  NativeCalculator.add теперь         │
    │  связан с нативным кодом             │
    └──────────────────────────────────────┘


    ПОСЛЕДУЮЩИЕ ВЫЗОВЫ (БЫСТРЫЕ):

    ┌─────────────────────────────────────────────────────────────┐
    │  JavaScript: NativeCalculator.add(5, 3)                     │
    └───────────┬─────────────────────────────────────────────────┘
                │  ~5 μs
                ↓
    ┌──────────────────────────────────────┐
    │  JSI Bridge (C++)                    │
    │  NativeCalculatorSpecJSI             │
    │                                      │
    │  • jsi::Value(5) → double(5.0)       │
    │  • jsi::Value(3) → double(3.0)       │
    │  • Прямой вызов C++ метода           │
    └───────────┬──────────────────────────┘
                │  ~3 μs
                ↓
    ┌──────────────────────────────────────┐
    │  Objective-C++ Implementation        │
    │  RCTNativeCalculator.mm              │
    │                                      │
    │  - (double)add:(double)a             │
    │              b:(double)b {           │
    │    NSLog(@"add called");             │
    │    return a + b;  // = 8.0           │
    │  }                                   │
    └───────────┬──────────────────────────┘
                │  ~2 μs
                ↓
    ┌──────────────────────────────────────┐
    │  JSI Bridge (C++)                    │
    │                                      │
    │  • double(8.0) → jsi::Value(8)       │
    │  • Возврат в JavaScript              │
    └───────────┬──────────────────────────┘
                │  ~3 μs
                ↓
    ┌──────────────────────────────────────┐
    │  JavaScript: sum = 8                 │
    └──────────────────────────────────────┘

    ⏱️ ИТОГО: ~13 μs (0.013 мс)


┌─────────────────────────────────────────────────────────────────────────────┐
│                    СРАВНЕНИЕ С LEGACY BRIDGE                                 │
└─────────────────────────────────────────────────────────────────────────────┘

    LEGACY BRIDGE (старый подход):

    JavaScript                 Native Thread
        │                           │
        │  1. Вызов метода          │
        ↓                           │
    [Serialize to JSON]             │
        │ (50-100 μs)               │
        ↓                           │
    ────────────────────────────────────
    │   Message Queue              │
    │   (асинхронная очередь)      │
    ────────────────────────────────────
        │                           ↓
        │              [Deserialize from JSON]
        │                      (50-100 μs)
        │                           ↓
        │                   [Execute method]
        │                           ↓
        │              [Serialize result to JSON]
        │                      (50-100 μs)
        │                           ↓
    ────────────────────────────────────
    │   Message Queue              │
    ────────────────────────────────────
        ↓                           │
    [Deserialize from JSON]         │
        │ (50-100 μs)               │
        ↓                           │
    Result available                │

    ⏱️ ИТОГО: 200-400 μs (0.2-0.4 мс)


    TURBO MODULES + JSI (новый подход):

    JavaScript              JSI Bridge           Native
        │                       │                   │
        ↓                       │                   │
    [Call method]               │                   │
        │ (5 μs)                │                   │
        ↓                       │                   │
    ════════════════════════════════════════════════
    │            JSI (синхронный)                 │
    ════════════════════════════════════════════════
        │                       ↓                   │
        │              [Type conversion]            │
        │                  (3 μs)                   │
        │                       ↓                   │
        │                       │              [Execute]
        │                       │                 (2 μs)
        │                       ↓                   │
        │              [Type conversion]            │
        │                  (3 μs)                   │
        ↓                       ↓                   │
    [Result]                    │                   │
        │ (5 μs)                │                   │

    ⏱️ ИТОГО: ~18 μs (0.018 мс)

    🚀 УСКОРЕНИЕ: ~15x быстрее!


┌─────────────────────────────────────────────────────────────────────────────┐
│                        ТИПЫ ДАННЫХ - КОНВЕРТАЦИЯ                             │
└─────────────────────────────────────────────────────────────────────────────┘

    TypeScript          →  Codegen генерирует  →  Native (iOS)
    ─────────────────────────────────────────────────────────────────

    number              →  double                →  double
    string              →  NSString *            →  NSString *
    boolean             →  BOOL                  →  BOOL

    Object              →  NSDictionary *        →  NSDictionary *
    Array<T>            →  NSArray *             →  NSArray *

    Promise<T>          →  resolve/reject        →  RCTPromiseResolve/RejectBlock
    callback            →  callback              →  RCTResponseSenderBlock

    null/undefined      →  nil                   →  nil

    void                →  void                  →  void


┌─────────────────────────────────────────────────────────────────────────────┐
│                     ЖИЗНЕННЫЙ ЦИКЛ МОДУЛЯ                                    │
└─────────────────────────────────────────────────────────────────────────────┘

    1. APP LAUNCH (Запуск приложения)
       ┌────────────────────────┐
       │ React Native init      │
       └───────┬────────────────┘
               │
               ↓
       ┌────────────────────────┐
       │ Сканирование модулей   │
       │ (RCTModuleProviders)   │
       └───────┬────────────────┘
               │
               ↓
       ┌────────────────────────┐
       │ Регистрация имен       │
       │ "NativeCalculator"     │
       └────────────────────────┘

       ⚠️ Модуль НЕ создан!
       Только имя зарегистрировано


    2. FIRST USE (Первое использование)
       ┌────────────────────────┐
       │ JS вызывает метод      │
       └───────┬────────────────┘
               │
               ↓
       ┌────────────────────────┐
       │ TurboModuleRegistry    │
       │ создает экземпляр      │
       └───────┬────────────────┘
               │
               ↓
       ┌────────────────────────┐
       │ [[RCTNativeCalculator  │
       │   alloc] init]         │
       └───────┬────────────────┘
               │
               ↓
       ┌────────────────────────┐
       │ getTurboModule:        │
       │ создает JSI binding    │
       └───────┬────────────────┘
               │
               ↓
       ┌────────────────────────┐
       │ Кэширование (singleton)│
       └────────────────────────┘


    3. SUBSEQUENT CALLS (Последующие вызовы)
       ┌────────────────────────┐
       │ Используется           │
       │ закэшированный         │
       │ экземпляр              │
       └────────────────────────┘

       ⚡ Очень быстро!


    4. APP TERMINATION (Закрытие приложения)
       ┌────────────────────────┐
       │ React Native shutdown  │
       └───────┬────────────────┘
               │
               ↓
       ┌────────────────────────┐
       │ Освобождение модулей   │
       └───────┬────────────────┘
               │
               ↓
       ┌────────────────────────┐
       │ [module dealloc]       │
       └────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                          ПОТОКИ ВЫПОЛНЕНИЯ                                   │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────────┐     ┌──────────────────────┐
    │   JavaScript Thread  │     │   Native Thread      │
    │   (Main / JS)        │     │   (может быть любой)  │
    └──────────┬───────────┘     └──────────┬───────────┘
               │                            │
               │                            │
               │  Синхронный метод          │
               │  (add, multiply)           │
               ├────────────────────────────>
               │         JSI call           │
               │         (10-20 μs)         │
               <────────────────────────────┤
               │         Result             │
               │                            │
               │                            │
               │  Асинхронный метод         │
               │  (factorial)               │
               ├────────────────────────────>
               │    Promise создан          │
    ┌──────────┤                            ├─────────┐
    │ resolve  │                            │ Вычисл. │
    │ ожидает  │                            │ на фоне │
    └──────────┤                            ├─────────┘
               <────────────────────────────┤
               │    resolve/reject          │
               │    (callback)              │
               │                            │


    requiresMainQueueSetup:

    + (BOOL)requiresMainQueueSetup {
      return NO;  // ← Можем инициализироваться в любом потоке
    }

    Если YES: модуль ДОЛЖЕН быть создан на Main Thread
    Если NO:  модуль может быть создан на Background Thread
              ⚡ Быстрее запуск приложения!


┌─────────────────────────────────────────────────────────────────────────────┐
│                              ИТОГИ                                           │
└─────────────────────────────────────────────────────────────────────────────┘

    ✅ Turbo Modules + Codegen = современный подход к Native Modules

    ⚡ JSI обеспечивает:
       • Прямой доступ к JavaScript объектам из C++
       • Синхронные вызовы без сериализации
       • Ускорение в 10-20 раз

    🤖 Codegen автоматизирует:
       • Генерацию протоколов
       • Конвертацию типов
       • Создание JSI bindings
       • Регистрацию модулей

    📦 Lazy Loading:
       • Модули создаются только при использовании
       • Быстрый старт приложения
       • Экономия памяти

    🔒 Type Safety:
       • TypeScript спецификация
       • Compile-time проверка типов
       • Невозможно вызвать с неправильными параметрами

```
